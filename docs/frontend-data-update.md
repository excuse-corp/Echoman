# å‰ç«¯æ•°æ®æ›´æ–°æµç¨‹è¯´æ˜

## æ¦‚è¿°

Echoman å‰ç«¯é€šè¿‡**è½®è¯¢ REST API** çš„æ–¹å¼è·å–åç«¯æ•°æ®æ›´æ–°ï¼Œæ— éœ€ WebSocket æˆ– SSE æ¨é€ã€‚

## æ•°æ®æµè½¬å…¨é“¾è·¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç«¯æ•°æ®å¤„ç†æµç¨‹                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

08:00-22:00  â†’ é‡‡é›†ä»»åŠ¡ï¼ˆæ¯2å°æ—¶ï¼‰
æ¯2å°æ—¶        â””â”€ SourceItems è¡¨æ’å…¥æ–°æ•°æ®
                 â”œâ”€ status: pending_halfday_merge
                 â””â”€ halfday_period: 2025-11-04_AM/PM

     â†“

12:15/22:15  â†’ ã€å½’å¹¶é˜¶æ®µä¸€ã€‘æ–°äº‹ä»¶å½’å¹¶ä»»åŠ¡
               â”œâ”€ çƒ­åº¦å½’ä¸€åŒ–
               â”œâ”€ å‘é‡èšç±»
               â”œâ”€ LLMåˆ¤å®š
               â”œâ”€ å‡ºç°æ¬¡æ•°ç­›é€‰ï¼ˆâ‰¥2æ¬¡ä¿ç•™ï¼‰
               â””â”€ æ›´æ–° SourceItems
                  â”œâ”€ ä¿ç•™: status â†’ pending_global_merge
                  â””â”€ ä¸¢å¼ƒ: status â†’ discarded

     â†“

12:30/22:30  â†’ ã€å½’å¹¶é˜¶æ®µäºŒã€‘æ•´ä½“å½’å¹¶ä»»åŠ¡
               â”œâ”€ å‘é‡æ£€ç´¢å†å²Topics
               â”œâ”€ LLMå…³è”åˆ¤å®š
               â”œâ”€ å†³ç­–: mergeï¼ˆå½’å…¥å·²æœ‰ä¸»é¢˜ï¼‰or newï¼ˆåˆ›å»ºæ–°ä¸»é¢˜ï¼‰
               â””â”€ æ•°æ®åº“å†™å…¥ï¼š
                  â”œâ”€ Topics è¡¨ï¼šæ–°å»ºæˆ–æ›´æ–°ä¸»é¢˜ âœ…
                  â”œâ”€ TopicNodes è¡¨ï¼šè®°å½•ä¸»é¢˜-æºæ•°æ®å…³è” âœ…
                  â”œâ”€ TopicHalfdayHeat è¡¨ï¼šè®°å½•åŠæ—¥çƒ­åº¦ âœ…
                  â””â”€ SourceItemsï¼šstatus â†’ merged âœ…

     â†“

å‰ç«¯APIè½®è¯¢  â†’ GET /api/v1/topics
               â””â”€ å‰ç«¯é¡µé¢æ˜¾ç¤ºæœ€æ–°çƒ­ç‚¹æ•°æ®

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯æ•°æ®è·å–æµç¨‹                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·è®¿é—®é¡µé¢
     â†“
useEffect() åˆå§‹åŒ–
     â†“
è°ƒç”¨ getHotspots() â†’ GET /api/v1/topics
     â†“
æ˜¾ç¤ºçƒ­ç‚¹åˆ—è¡¨
     â†“
ç”¨æˆ·é€‰æ‹©çƒ­ç‚¹
     â†“
è°ƒç”¨ getTopicDetail() â†’ GET /api/v1/topics/{id}
è°ƒç”¨ getTimeline() â†’ GET /api/v1/topics/{id}/timeline
     â†“
æ˜¾ç¤ºçƒ­ç‚¹è¯¦æƒ…å’Œæ—¶é—´çº¿
```

## å‰ç«¯æ•°æ®æ›´æ–°æœºåˆ¶

### å½“å‰å®ç°ï¼šé¡µé¢åŠ è½½æ—¶è·å–

```typescript
// frontend/src/pages/ExplorerPage.tsx
useEffect(() => {
  let cancel = false;
  getHotspots().then(({ items, fallback }) => {
    if (cancel) return;
    setHotspots(items);
    setUsingFallback(fallback);
  });
  return () => {
    cancel = true;
  };
}, []); // ç©ºä¾èµ–æ•°ç»„ â†’ ä»…åœ¨ç»„ä»¶æŒ‚è½½æ—¶æ‰§è¡Œä¸€æ¬¡
```

**ç‰¹ç‚¹**ï¼š
- âœ… ç®€å•ï¼Œæ— é¢å¤–ç½‘ç»œè´Ÿæ‹…
- âŒ ä¸ä¼šè‡ªåŠ¨åˆ·æ–°ï¼Œéœ€è¦æ‰‹åŠ¨åˆ·æ–°é¡µé¢

### å‡çº§æ–¹æ¡ˆï¼šå®šæ—¶è½®è¯¢ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦è‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼Œå¯ä»¥æ·»åŠ å®šæ—¶è½®è¯¢ï¼š

```typescript
useEffect(() => {
  let cancel = false;
  
  // ç«‹å³è·å–ä¸€æ¬¡
  const fetchData = () => {
    getHotspots().then(({ items, fallback }) => {
      if (cancel) return;
      setHotspots(items);
      setUsingFallback(fallback);
    });
  };
  
  fetchData();
  
  // æ¯5åˆ†é’Ÿè½®è¯¢ä¸€æ¬¡
  const interval = setInterval(fetchData, 5 * 60 * 1000);
  
  return () => {
    cancel = true;
    clearInterval(interval);
  };
}, []);
```

**è½®è¯¢é¢‘ç‡å»ºè®®**ï¼š
- å½’å¹¶ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼š12:15-12:30 å’Œ 22:15-22:30ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
- è½®è¯¢é—´éš”ï¼š5-10åˆ†é’Ÿï¼ˆå¹³è¡¡åŠæ—¶æ€§å’ŒæœåŠ¡å™¨å‹åŠ›ï¼‰
- æˆ–è€…ï¼šä»…åœ¨å½’å¹¶æ—¶æ®µï¼ˆ12:00-12:45, 22:00-22:45ï¼‰åŠ å¯†è½®è¯¢ï¼ˆ1åˆ†é’Ÿï¼‰ï¼Œå…¶ä»–æ—¶æ®µä¸è½®è¯¢

## æ•°æ®åº“å…¥åº“éªŒè¯

### å½’å¹¶ç»“æœå…¥åº“æ£€æŸ¥

```bash
# æ£€æŸ¥ Topics è¡¨
SELECT COUNT(*) FROM topics;
SELECT * FROM topics ORDER BY created_at DESC LIMIT 5;

# æ£€æŸ¥ TopicNodes è¡¨ï¼ˆä¸»é¢˜-æºæ•°æ®å…³è”ï¼‰
SELECT COUNT(*) FROM topic_nodes;
SELECT * FROM topic_nodes ORDER BY appended_at DESC LIMIT 5;

# æ£€æŸ¥ TopicHalfdayHeat è¡¨ï¼ˆåŠæ—¥çƒ­åº¦å¿«ç…§ï¼‰
SELECT COUNT(*) FROM topic_halfday_heat;
SELECT * FROM topic_halfday_heat ORDER BY date DESC, created_at DESC LIMIT 5;

# æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
SELECT 
  (SELECT COUNT(*) FROM source_items WHERE merge_status = 'merged') AS merged_items,
  (SELECT COUNT(*) FROM topic_nodes) AS topic_nodes,
  CASE 
    WHEN (SELECT COUNT(*) FROM source_items WHERE merge_status = 'merged') = 
         (SELECT COUNT(*) FROM topic_nodes)
    THEN 'âœ… ä¸€è‡´'
    ELSE 'âŒ ä¸ä¸€è‡´'
  END AS integrity_check;
```

### æœ€æ–°æµ‹è¯•ç»“æœï¼ˆ2025-11-04ï¼‰

```
ğŸ“Œ Topics è¡¨: 32 æ¡è®°å½•
   - å·²æ­£å¸¸å…¥åº“ï¼ŒåŒ…å«æ ‡é¢˜ã€åˆ†ç±»ã€çŠ¶æ€ç­‰å­—æ®µ

ğŸ”— TopicNodes è¡¨: 67 æ¡è®°å½•
   - è®°å½•äº†ä¸»é¢˜ä¸æºæ•°æ®çš„å…³è”å…³ç³»

ğŸ”¥ TopicHalfdayHeat è¡¨: 32 æ¡è®°å½•
   - è®°å½•äº†æ¯ä¸ªä¸»é¢˜åœ¨å„åŠæ—¥æ—¶æ®µçš„çƒ­åº¦å¿«ç…§

ğŸ“Š SourceItems å½’å¹¶çŠ¶æ€:
   - pending_halfday_merge: 1763 æ¡ï¼ˆå¾…é˜¶æ®µä¸€å¤„ç†ï¼‰
   - pending_global_merge: 17 æ¡ï¼ˆå¾…é˜¶æ®µäºŒå¤„ç†ï¼‰
   - merged: 67 æ¡ï¼ˆå·²å½’å¹¶ï¼‰
   - discarded: 381 æ¡ï¼ˆå™ªéŸ³æ•°æ®ï¼‰

âœ… æ•°æ®å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡ï¼šmerged items ä¸ TopicNodes æ•°é‡ä¸€è‡´
```

## API ç«¯ç‚¹è¯´æ˜

### 1. è·å–çƒ­ç‚¹åˆ—è¡¨

```http
GET /api/v1/topics
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "items": [
    {
      "topic_id": "60",
      "title": "å±±å§†åœ¨äº‰è®®å£°ä¸­å†æ›´æ–°APP",
      "summary": "...",
      "intensity_raw": 2,
      "intensity_norm": 100.0,
      "length_days": 0.0,
      "first_seen": "2025-11-04T09:02:33",
      "last_active": "2025-11-04T09:02:33",
      "platforms": ["weibo", "zhihu"],
      "platform_mentions": {...},
      "status": "active"
    }
  ]
}
```

### 2. è·å–çƒ­ç‚¹è¯¦æƒ…

```http
GET /api/v1/topics/{topic_id}
```

### 3. è·å–çƒ­ç‚¹æ—¶é—´çº¿

```http
GET /api/v1/topics/{topic_id}/timeline
```

## æ•°æ®æ›´æ–°æ—¶é—´è¡¨ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰

| æ—¶é—´ | ä»»åŠ¡ | è¯´æ˜ |
|------|------|------|
| 08:00 | é‡‡é›†ä»»åŠ¡ #1 | çˆ¬å–å„å¹³å°çƒ­ç‚¹ |
| 10:00 | é‡‡é›†ä»»åŠ¡ #2 | |
| 12:00 | é‡‡é›†ä»»åŠ¡ #3 | |
| **12:15** | **å½’å¹¶é˜¶æ®µä¸€ï¼ˆAMï¼‰** | å¯¹8:00-12:00çš„æ•°æ®å»å™ª |
| **12:30** | **å½’å¹¶é˜¶æ®µäºŒï¼ˆAMï¼‰** | ä¸å†å²Topicæ¯”å¯¹ï¼Œæ›´æ–°æ•°æ®åº“ âœ… |
| 14:00 | é‡‡é›†ä»»åŠ¡ #4 | |
| 16:00 | é‡‡é›†ä»»åŠ¡ #5 | |
| 18:00 | é‡‡é›†ä»»åŠ¡ #6 | |
| 20:00 | é‡‡é›†ä»»åŠ¡ #7 | |
| 22:00 | é‡‡é›†ä»»åŠ¡ #8 | |
| **22:15** | **å½’å¹¶é˜¶æ®µä¸€ï¼ˆPMï¼‰** | å¯¹14:00-22:00çš„æ•°æ®å»å™ª |
| **22:30** | **å½’å¹¶é˜¶æ®µäºŒï¼ˆPMï¼‰** | ä¸å†å²Topicæ¯”å¯¹ï¼Œæ›´æ–°æ•°æ®åº“ âœ… |

**å‰ç«¯æ•°æ®æ›´æ–°æ—¶æœº**ï¼š
- å½“å‰ï¼šé¡µé¢åŠ è½½æ—¶è·å–ä¸€æ¬¡
- å»ºè®®ï¼šåœ¨ 12:30-12:45 å’Œ 22:30-22:45 æœŸé—´å¢åŠ è½®è¯¢é¢‘ç‡ï¼ˆå¦‚1åˆ†é’Ÿï¼‰
- å…¶ä»–æ—¶æ®µï¼šä¿æŒå½“å‰ç­–ç•¥æˆ–é™ä½è½®è¯¢é¢‘ç‡ï¼ˆå¦‚5-10åˆ†é’Ÿï¼‰

## å‰ç«¯fallbackæœºåˆ¶

å½“åç«¯APIä¸å¯ç”¨æ—¶ï¼Œå‰ç«¯ä¼šä½¿ç”¨å†…ç½®çš„æ¨¡æ‹Ÿæ•°æ®ï¼ˆfallback dataï¼‰ï¼š

```typescript
// frontend/src/services/api.ts
export async function getHotspots(): Promise<{ items: HotspotSummary[]; fallback: boolean }> {
  try {
    const response = await fetch(`${API_BASE_URL}/topics`);
    if (!response.ok) {
      throw new Error(`Bad status: ${response.status}`);
    }
    const payload = await response.json();
    return { items: payload.items as HotspotSummary[], fallback: false };
  } catch (error) {
    console.warn("[api] getHotspots fallback, reason:", error);
    return { items: fallbackHotspots, fallback: true }; // ä½¿ç”¨å†…ç½®æ¨¡æ‹Ÿæ•°æ®
  }
}
```

## æ€»ç»“

### æ•°æ®æµè½¬
1. **é‡‡é›†** â†’ SourceItems è¡¨ï¼ˆpending_halfday_mergeï¼‰
2. **é˜¶æ®µä¸€** â†’ å»å™ªç­›é€‰ â†’ SourceItemsï¼ˆpending_global_merge æˆ– discardedï¼‰
3. **é˜¶æ®µäºŒ** â†’ å½’å¹¶å†³ç­– â†’ **Topics/TopicNodes/TopicHalfdayHeat è¡¨æ›´æ–°** âœ…
4. **å‰ç«¯** â†’ é€šè¿‡ API è½®è¯¢è·å–æœ€æ–°æ•°æ®

### å‰ç«¯æ›´æ–°æ–¹å¼
- **å½“å‰**ï¼šé¡µé¢åŠ è½½æ—¶è·å–ä¸€æ¬¡ï¼ˆç®€å•ã€ä½è´Ÿæ‹…ï¼‰
- **å¯é€‰å‡çº§**ï¼šå®šæ—¶è½®è¯¢ï¼ˆ5-10åˆ†é’Ÿï¼‰æˆ–æ™ºèƒ½è½®è¯¢ï¼ˆå½’å¹¶æ—¶æ®µå¯†é›†è½®è¯¢ï¼‰

### æ•°æ®åº“å…¥åº“
- âœ… Topics è¡¨ï¼šå·²æ­£å¸¸å…¥åº“
- âœ… TopicNodes è¡¨ï¼šå·²æ­£å¸¸å…¥åº“
- âœ… TopicHalfdayHeat è¡¨ï¼šå·²æ­£å¸¸å…¥åº“
- âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯ï¼šé€šè¿‡

å½’å¹¶æµç¨‹å®Œæ•´ï¼Œæ•°æ®æµè½¬æ­£å¸¸ï¼ğŸ‰



